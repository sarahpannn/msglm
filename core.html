<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="description" content="Create messages for language models like Claude and OpenAI GPTs.">

<title>core – msglm</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js" type="module"></script>
<script src="site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-b1527d6dab3c1d2528611d399e709420.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="styles.css">
<meta property="og:title" content="core – msglm">
<meta property="og:description" content="Create messages for language models like Claude and OpenAI GPTs.">
<meta property="og:site_name" content="msglm">
<meta name="twitter:title" content="core – msglm">
<meta name="twitter:description" content="Create messages for language models like Claude and OpenAI GPTs.">
<meta name="twitter:card" content="summary">
</head>

<body class="nav-sidebar floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">msglm</span>
    </a>
  </div>
        <div class="quarto-navbar-tools tools-end">
</div>
          <div id="quarto-search" class="" title="Search"></div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./core.html">core</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">msglm</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./core.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">core</span></a>
  </div>
</li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#api-exploration" id="toc-api-exploration" class="nav-link active" data-scroll-target="#api-exploration">API Exploration</a>
  <ul class="collapse">
  <li><a href="#mk_msg" id="toc-mk_msg" class="nav-link" data-scroll-target="#mk_msg">mk_msg</a></li>
  <li><a href="#images" id="toc-images" class="nav-link" data-scroll-target="#images">Images</a></li>
  </ul></li>
  <li><a href="#msg-class" id="toc-msg-class" class="nav-link" data-scroll-target="#msg-class">Msg Class</a>
  <ul class="collapse">
  <li><a href="#basics" id="toc-basics" class="nav-link" data-scroll-target="#basics">Basics</a></li>
  <li><a href="#msg" id="toc-msg" class="nav-link" data-scroll-target="#msg">Msg</a></li>
  <li><a href="#openaimsg" id="toc-openaimsg" class="nav-link" data-scroll-target="#openaimsg">OpenAiMsg</a></li>
  <li><a href="#anthropicmsg" id="toc-anthropicmsg" class="nav-link" data-scroll-target="#anthropicmsg">AnthropicMsg</a></li>
  <li><a href="#msg.mk_content" id="toc-msg.mk_content" class="nav-link" data-scroll-target="#msg.mk_content">Msg.mk_content</a></li>
  <li><a href="#openaimsg.text_msg" id="toc-openaimsg.text_msg" class="nav-link" data-scroll-target="#openaimsg.text_msg">OpenAiMsg.text_msg</a></li>
  <li><a href="#openaimsg.img_msg" id="toc-openaimsg.img_msg" class="nav-link" data-scroll-target="#openaimsg.img_msg">OpenAiMsg.img_msg</a></li>
  <li><a href="#anthropicmsg.text_msg" id="toc-anthropicmsg.text_msg" class="nav-link" data-scroll-target="#anthropicmsg.text_msg">AnthropicMsg.text_msg</a></li>
  <li><a href="#anthropicmsg.img_msg" id="toc-anthropicmsg.img_msg" class="nav-link" data-scroll-target="#anthropicmsg.img_msg">AnthropicMsg.img_msg</a></li>
  <li><a href="#mk_msg-1" id="toc-mk_msg-1" class="nav-link" data-scroll-target="#mk_msg-1">mk_msg</a></li>
  <li><a href="#pdfs" id="toc-pdfs" class="nav-link" data-scroll-target="#pdfs">PDFs</a></li>
  <li><a href="#anthropicmsg.pdf_msg" id="toc-anthropicmsg.pdf_msg" class="nav-link" data-scroll-target="#anthropicmsg.pdf_msg">AnthropicMsg.pdf_msg</a></li>
  <li><a href="#conversation" id="toc-conversation" class="nav-link" data-scroll-target="#conversation">Conversation</a></li>
  <li><a href="#sdk-objects" id="toc-sdk-objects" class="nav-link" data-scroll-target="#sdk-objects">SDK Objects</a></li>
  <li><a href="#msg.__call__" id="toc-msg.__call__" class="nav-link" data-scroll-target="#msg.__call__">Msg.__call__</a></li>
  <li><a href="#anthropicmsg.find_block" id="toc-anthropicmsg.find_block" class="nav-link" data-scroll-target="#anthropicmsg.find_block">AnthropicMsg.find_block</a></li>
  <li><a href="#anthropicmsg.is_sdk_obj" id="toc-anthropicmsg.is_sdk_obj" class="nav-link" data-scroll-target="#anthropicmsg.is_sdk_obj">AnthropicMsg.is_sdk_obj</a></li>
  <li><a href="#openaimsg.find_block" id="toc-openaimsg.find_block" class="nav-link" data-scroll-target="#openaimsg.find_block">OpenAiMsg.find_block</a></li>
  <li><a href="#openaimsg.is_sdk_obj" id="toc-openaimsg.is_sdk_obj" class="nav-link" data-scroll-target="#openaimsg.is_sdk_obj">OpenAiMsg.is_sdk_obj</a></li>
  <li><a href="#mk_msgs" id="toc-mk_msgs" class="nav-link" data-scroll-target="#mk_msgs">mk_msgs</a></li>
  <li><a href="#usage" id="toc-usage" class="nav-link" data-scroll-target="#usage">Usage</a></li>
  </ul></li>
  <li><a href="#extra-features" id="toc-extra-features" class="nav-link" data-scroll-target="#extra-features">Extra features</a>
  <ul class="collapse">
  <li><a href="#caching" id="toc-caching" class="nav-link" data-scroll-target="#caching">Caching</a></li>
  <li><a href="#mk_msgs_anthropic" id="toc-mk_msgs_anthropic" class="nav-link" data-scroll-target="#mk_msgs_anthropic">mk_msgs_anthropic</a></li>
  <li><a href="#mk_msg_anthropic" id="toc-mk_msg_anthropic" class="nav-link" data-scroll-target="#mk_msg_anthropic">mk_msg_anthropic</a></li>
  <li><a href="#citations" id="toc-citations" class="nav-link" data-scroll-target="#citations">Citations</a></li>
  <li><a href="#mk_ant_doc" id="toc-mk_ant_doc" class="nav-link" data-scroll-target="#mk_ant_doc">mk_ant_doc</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/AnswerDotAI/msglm/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div><div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="core.html.md"><i class="bi bi-file-code"></i>CommonMark</a></li></ul></div></nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">core</h1>
</div>

<div>
  <div class="description">
    Create messages for language models like Claude and OpenAI GPTs.
  </div>
</div>


<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<!-- WARNING: THIS FILE WAS AUTOGENERATED! DO NOT EDIT! -->
<div id="cell-2" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> Image, display</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-3" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="api-exploration" class="level2">
<h2 class="anchored" data-anchor-id="api-exploration">API Exploration</h2>
<p>Anthropic’s Claude and OpenAI’s GPT models are some of the most popular LLMs.</p>
<p>Let’s take a look at their APIs and to learn how we should structure our messages for a simple text chat.</p>
<section id="openai" class="level4">
<h4 class="anchored" data-anchor-id="openai">openai</h4>
<div id="cell-7" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> openai <span class="im">import</span> OpenAI</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-8" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> OpenAI()</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>client.responses.create(</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>  model<span class="op">=</span><span class="st">"gpt-4.1"</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>  <span class="bu">input</span><span class="op">=</span>[ {<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: <span class="st">"Hello, world!"</span>} ]</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="9">
<p>Hello, world! 👋 How can I assist you today?</p>
<details>
<ul>
<li>id: resp_6861e1ad4b7c81a1b4d6c1cc66589bbe0972cbf25d9578d3</li>
<li>created_at: 1751245229.0</li>
<li>error: None</li>
<li>incomplete_details: None</li>
<li>instructions: None</li>
<li>metadata: {}</li>
<li>model: gpt-4.1-2025-04-14</li>
<li>object: response</li>
<li>output: [ResponseOutputMessage(id=‘msg_6861e1ad9a1081a1a83cbc85bdf794ac0972cbf25d9578d3’, content=[ResponseOutputText(annotations=[], text=‘Hello, world! 👋 How can I assist you today?’, type=‘output_text’, logprobs=[])], role=‘assistant’, status=‘completed’, type=‘message’)]</li>
<li>parallel_tool_calls: True</li>
<li>temperature: 1.0</li>
<li>tool_choice: auto</li>
<li>tools: []</li>
<li>top_p: 1.0</li>
<li>background: False</li>
<li>max_output_tokens: None</li>
<li>max_tool_calls: None</li>
<li>previous_response_id: None</li>
<li>prompt: None</li>
<li>reasoning: Reasoning(effort=None, generate_summary=None, summary=None)</li>
<li>service_tier: default</li>
<li>status: completed</li>
<li>text: ResponseTextConfig(format=ResponseFormatText(type=‘text’))</li>
<li>top_logprobs: 0</li>
<li>truncation: disabled</li>
<li>usage: ResponseUsage(input_tokens=11, input_tokens_details=InputTokensDetails(cached_tokens=0), output_tokens=14, output_tokens_details=OutputTokensDetails(reasoning_tokens=0), total_tokens=25)</li>
<li>user: None</li>
<li>store: True</li>
</ul>
</details>
</div>
</div>
</section>
<section id="anthropic" class="level4">
<h4 class="anchored" data-anchor-id="anthropic">anthropic</h4>
<div id="cell-10" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> anthropic <span class="im">import</span> Anthropic</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-11" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> Anthropic()</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>client.messages.create(</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"claude-3-haiku-20240307"</span>,</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    max_tokens<span class="op">=</span><span class="dv">1024</span>,</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    messages<span class="op">=</span>[ {<span class="st">"role"</span>: <span class="st">"user"</span>, <span class="st">"content"</span>: <span class="st">"Hello, world!"</span>} ]</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="17">
<p>Hello! It’s nice to meet you. How can I assist you today?</p>
<details>
<ul>
<li>id: <code>msg_01SB8Rrc2eJ3okM8A5zwpHTf</code></li>
<li>content: <code>[{'citations': None, 'text': "Hello! It's nice to meet you. How can I assist you today?", 'type': 'text'}]</code></li>
<li>model: <code>claude-3-haiku-20240307</code></li>
<li>role: <code>assistant</code></li>
<li>stop_reason: <code>end_turn</code></li>
<li>stop_sequence: <code>None</code></li>
<li>type: <code>message</code></li>
<li>usage: <code>{'cache_creation_input_tokens': 0, 'cache_read_input_tokens': 0, 'input_tokens': 11, 'output_tokens': 19, 'server_tool_use': None, 'service_tier': 'standard'}</code></li>
</ul>
</details>
</div>
</div>
<p>As we can see both APIs use the exact same message structure.</p>
</section>
<section id="mk_msg" class="level3">
<h3 class="anchored" data-anchor-id="mk_msg">mk_msg</h3>
<p>Ok, let’s build the first version of <a href="https://AnswerDotAI.github.io/msglm/core.html#mk_msg"><code>mk_msg</code></a> to handle this case</p>
<div id="cell-15" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_msg(content:<span class="bu">str</span>, role:<span class="bu">str</span><span class="op">=</span><span class="st">"user"</span>)<span class="op">-&gt;</span><span class="bu">dict</span>:</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Create an OpenAI/Anthropic compatible message."</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">dict</span>(role<span class="op">=</span>role, content<span class="op">=</span>content)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s test it out with the OpenAI API. To do that we’ll need to setup two things:</p>
<ul>
<li>install the openai SDK by running <code>pip install openai</code></li>
<li>add your openai api key to your env vars <code>export OPENAI_API_KEY="YOUR_OPEN_API_KEY"</code></li>
</ul>
<div id="cell-17" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>oa_cli <span class="op">=</span> OpenAI()</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> oa_cli.responses.create(</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>  model<span class="op">=</span><span class="st">"gpt-4o-mini"</span>,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="bu">input</span><span class="op">=</span>[mk_msg(<span class="st">"Hello, world!"</span>)]</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>r.output_text</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>'Hello! How can I assist you today?'</code></pre>
</div>
</div>
<p>Now, let’s test out <a href="https://AnswerDotAI.github.io/msglm/core.html#mk_msg"><code>mk_msg</code></a> on the Anthropic API. To do that we’ll need to setup two things:</p>
<ul>
<li>install the openai SDK by running <code>pip install anthropic</code></li>
<li>add your anthropic api key to your env vars <code>export ANTHROPIC_API_KEY="YOUR_ANTHROPIC_API_KEY"</code></li>
</ul>
<div id="cell-19" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>a_cli <span class="op">=</span> Anthropic()</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> a_cli.messages.create(</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"claude-3-haiku-20240307"</span>,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    max_tokens<span class="op">=</span><span class="dv">1024</span>,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    messages<span class="op">=</span>[mk_msg(<span class="st">"Hello, world!"</span>)]</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>r.content[<span class="dv">0</span>].text</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>"Hello! It's great to meet you. How can I assist you today?"</code></pre>
</div>
</div>
<p>So far so good!</p>
<section id="helper-functions" class="level4">
<h4 class="anchored" data-anchor-id="helper-functions">Helper Functions</h4>
<p>Before going any further, let’s create some helper functions to make it a little easier to call the OpenAI and Anthropic APIs. We’re going to be making a bunch of API calls to test our code and typing the full expressions out each time will become a little tedious. These functions won’t be included in the final package.</p>
<div id="cell-23" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> openai_chat(msgs: <span class="bu">list</span>)<span class="op">-&gt;</span><span class="bu">tuple</span>:</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"call the openai chat responses endpoint with `msgs`."</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> oa_cli.responses.create(model<span class="op">=</span><span class="st">"o4-mini"</span>, <span class="bu">input</span><span class="op">=</span>msgs)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> r, r.output_text</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s double check that <a href="https://AnswerDotAI.github.io/msglm/core.html#mk_msg"><code>mk_msg</code></a> still works with our simple text example from before.</p>
<div id="cell-25" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>_, text <span class="op">=</span> openai_chat([mk_msg(<span class="st">"Hello, world!"</span>)])</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>text</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="22">
<pre><code>'Hello there! How can I assist you today?'</code></pre>
</div>
</div>
<div id="cell-26" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> anthropic_chat(msgs: <span class="bu">list</span>)<span class="op">-&gt;</span><span class="bu">tuple</span>:</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"call the anthropic messages endpoint with `msgs`."</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> a_cli.messages.create(model<span class="op">=</span><span class="st">"claude-sonnet-4-20250514"</span>, max_tokens<span class="op">=</span><span class="dv">1024</span>, messages<span class="op">=</span>msgs)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> r, r.content[<span class="dv">0</span>].text</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>and Anthropic…</p>
<div id="cell-28" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>_, text <span class="op">=</span> anthropic_chat([mk_msg(<span class="st">"Hello, world!"</span>)])</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>text</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="24">
<pre><code>'Hello! Nice to meet you! How are you doing today? Is there anything I can help you with?'</code></pre>
</div>
</div>
</section>
</section>
<section id="images" class="level3">
<h3 class="anchored" data-anchor-id="images">Images</h3>
<p>Ok, let’s see how both APIs handle image messages.</p>
<p><img src="https://claudette.answer.ai/index_files/figure-html/cell-35-output-1.jpeg" height="240" width="240"></p>
<section id="openai-1" class="level4">
<h4 class="anchored" data-anchor-id="openai-1">openai</h4>
<div id="cell-32" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> base64, httpx</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-33" class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>img_url <span class="op">=</span> <span class="st">"https://claudette.answer.ai/index_files/figure-html/cell-35-output-1.jpeg"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-34" class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>mtype <span class="op">=</span> <span class="st">"image/jpeg"</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>img_content <span class="op">=</span> httpx.get(img_url).content</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-35" class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>img <span class="op">=</span> base64.b64encode(img_content).decode(<span class="st">"utf-8"</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> OpenAI()</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> client.responses.create(</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"gpt-4o-mini"</span>,</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">input</span><span class="op">=</span>[</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>            <span class="st">"role"</span>:<span class="st">"user"</span>,</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>            <span class="st">"content"</span>: [</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>                {<span class="st">"type"</span>:<span class="st">"input_text"</span>,<span class="st">"text"</span>:<span class="st">"What's in this image?"</span>},</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>                {<span class="st">"type"</span>:<span class="st">"input_image"</span>,<span class="st">"image_url"</span>:<span class="ss">f"data:image/jpeg;base64,</span><span class="sc">{</span>img<span class="sc">}</span><span class="ss">"</span>},</span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>            ],</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb21-15"><a href="#cb21-15" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb21-16"><a href="#cb21-16" aria-hidden="true" tabindex="-1"></a>r.output_text</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'The image contains a puppy lying on the grass near some flowers. The puppy has a white coat with brown markings and appears to be playful and curious. The setting seems to be outdoors, with greenery and blooming flowers in the background.'</code></pre>
</div>
</div>
</section>
<section id="anthropic-1" class="level4">
<h4 class="anchored" data-anchor-id="anthropic-1">anthropic</h4>
<div id="cell-37" class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>mtype <span class="op">=</span> <span class="st">"image/jpeg"</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>img <span class="op">=</span> base64.b64encode(img_content).decode(<span class="st">"utf-8"</span>)</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> Anthropic()</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>r <span class="op">=</span> client.messages.create(</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"claude-3-haiku-20240307"</span>,</span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>    max_tokens<span class="op">=</span><span class="dv">1024</span>,</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    messages<span class="op">=</span>[</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>            <span class="st">"role"</span>:<span class="st">"user"</span>,</span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>            <span class="st">"content"</span>: [</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>                {<span class="st">"type"</span>:<span class="st">"text"</span>,<span class="st">"text"</span>:<span class="st">"What's in this image?"</span>},</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>                {<span class="st">"type"</span>:<span class="st">"image"</span>,<span class="st">"source"</span>:{<span class="st">"type"</span>:<span class="st">"base64"</span>,<span class="st">"media_type"</span>:mtype,<span class="st">"data"</span>:img}}</span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>            ],</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a>r.content[<span class="dv">0</span>].text</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>"This image shows a cute puppy lying in a grassy area with purple flowers in the background. The puppy appears to be a Cavalier King Charles Spaniel, with a long, silky coat in a reddish-brown color with white markings. The puppy has a friendly, inquisitive expression on its face as it gazes directly at the camera. The image conveys a sense of tranquility and natural beauty, with the vibrant purple flowers providing a lovely contrast to the puppy's warm coloring."</code></pre>
</div>
</div>
<p>Both APIs format images slightly differently and the structure of the message <code>content</code> is a little more complex.</p>
<p>In a text chat, <code>content</code> is a simple string but for a multimodal chat (text+images) we can see that <code>content</code> is a list of dictionaries.</p>
</section>
</section>
</section>
<section id="msg-class" class="level2">
<h2 class="anchored" data-anchor-id="msg-class">Msg Class</h2>
<section id="basics" class="level3">
<h3 class="anchored" data-anchor-id="basics">Basics</h3>
<p>Let’s create <a href="https://AnswerDotAI.github.io/msglm/core.html#_mk_img"><code>_mk_img</code></a> to make our code a little DRY’r.</p>
<div id="cell-42" class="cell">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _mk_img(data:<span class="bu">bytes</span>)<span class="op">-&gt;</span><span class="bu">tuple</span>:</span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Convert image bytes to a base64 encoded image"</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>    img <span class="op">=</span> base64.b64encode(data).decode(<span class="st">"utf-8"</span>)</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>    mtype <span class="op">=</span> mimetypes.types_map[<span class="st">"."</span><span class="op">+</span>imghdr.what(<span class="va">None</span>, h<span class="op">=</span>data)]</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> img, mtype</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>To handle the additional complexity of multimodal messages let’s build a <a href="https://AnswerDotAI.github.io/msglm/core.html#msg"><code>Msg</code></a> class for the <code>content</code> data structure:</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"role"</span><span class="fu">:</span> <span class="st">"user"</span><span class="fu">,</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="dt">"content"</span><span class="fu">:</span> <span class="ot">[</span><span class="fu">{</span><span class="dt">"type"</span><span class="fu">:</span> <span class="st">"text"</span><span class="fu">,</span> <span class="dt">"text"</span><span class="fu">:</span> <span class="st">"What's in this image?"</span><span class="fu">}</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
<p><a href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L26" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="msg" class="level3">
<h3 class="anchored" data-anchor-id="msg">Msg</h3>
<blockquote class="blockquote">
<pre><code> Msg ()</code></pre>
</blockquote>
<p><em>Helper class to create a message for the OpenAI and Anthropic APIs.</em></p>
<div id="cell-45" class="cell" data-execution_count="26">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> Msg:</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Helper class to create a message for the OpenAI and Anthropic APIs."</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>As both APIs handle images differently let’s subclass <a href="https://AnswerDotAI.github.io/msglm/core.html#msg"><code>Msg</code></a> for each API and handle the image formatting in a method called <code>img_msg</code>.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L31" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="openaimsg" class="level3">
<h3 class="anchored" data-anchor-id="openaimsg">OpenAiMsg</h3>
<blockquote class="blockquote">
<pre><code> OpenAiMsg ()</code></pre>
</blockquote>
<p><em>Helper class to create a message for the OpenAI API.</em></p>
<div id="cell-48" class="cell" data-execution_count="27">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> OpenAiMsg(Msg):</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Helper class to create a message for the OpenAI API."</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L36" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="anthropicmsg" class="level3">
<h3 class="anchored" data-anchor-id="anthropicmsg">AnthropicMsg</h3>
<blockquote class="blockquote">
<pre><code> AnthropicMsg ()</code></pre>
</blockquote>
<p><em>Helper class to create a message for the Anthropic API.</em></p>
<div id="cell-50" class="cell" data-execution_count="44">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> AnthropicMsg(Msg):</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Helper class to create a message for the Anthropic API."</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s write some helper functions for <code>mk_content</code> to use.</p>
<div id="cell-52" class="cell" data-execution_count="29">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _is_img(data): <span class="cf">return</span> <span class="bu">isinstance</span>(data, <span class="bu">bytes</span>) <span class="kw">and</span> <span class="bu">bool</span>(imghdr.what(<span class="va">None</span>, data))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>A PDF <a href="https://docs.fileformat.com/pdf/#pdf-file-header">file</a> should start with <code>%PDF</code> followed by the pdf version <code>%PDF-1.1</code></p>
<div id="cell-54" class="cell" data-execution_count="83">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _is_pdf(data): </span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    is_byte_pdf <span class="op">=</span> <span class="bu">isinstance</span>(data, <span class="bu">bytes</span>) <span class="kw">and</span> data.startswith(<span class="st">b'%PDF-'</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    is_pdf_url <span class="op">=</span> <span class="bu">isinstance</span>(data, <span class="bu">str</span>) <span class="kw">and</span> (data.startswith(<span class="st">"http"</span>) <span class="kw">and</span> data.endswith(<span class="st">".pdf"</span>) <span class="kw">or</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>   <span class="st">'pdf'</span> <span class="kw">in</span> data.split(<span class="st">'/'</span>))</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> is_byte_pdf <span class="kw">or</span> is_pdf_url</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<div id="cell-55" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(_is_pdf(<span class="st">"https://arxiv.org/pdf/2301.00001"</span>))</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(_is_pdf(<span class="st">"https://arxiv.org/abs/2301.00001"</span>))</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(_is_pdf(<span class="st">"https://assets.anthropic.com/m/1cd9d098ac3e6467/original/Claude-3-Model-Card-October-Addendum.pdf"</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>True
False
True</code></pre>
</div>
</div>
<p>We create an appropriate type based on content:</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L52" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="msg.mk_content" class="level3">
<h3 class="anchored" data-anchor-id="msg.mk_content">Msg.mk_content</h3>
<blockquote class="blockquote">
<pre><code> Msg.mk_content (content, text_only=False)</code></pre>
</blockquote>
<div id="cell-58" class="cell" data-execution_count="81">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_content(<span class="va">self</span>:Msg, content, text_only<span class="op">=</span><span class="va">False</span>)<span class="op">-&gt;</span><span class="bu">dict</span>:</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> _is_img(content): </span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.img_msg(content)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> _is_pdf(content): </span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.pdf_msg(content)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(content, <span class="bu">str</span>): <span class="cf">return</span> <span class="va">self</span>.text_msg(content, text_only<span class="op">=</span>text_only)</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> content</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>…then we call the model with this content:</p>
<div id="cell-60" class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> <span class="fu">__call__</span>(<span class="va">self</span>:Msg, role:<span class="bu">str</span>, content:[<span class="bu">list</span>, <span class="bu">str</span>], text_only:<span class="bu">bool</span><span class="op">=</span><span class="va">False</span>, <span class="op">**</span>kw)<span class="op">-&gt;</span><span class="bu">dict</span>:</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Create an OpenAI/Anthropic compatible message with `role` and `content`."</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> content <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> <span class="kw">not</span> <span class="bu">isinstance</span>(content, <span class="bu">list</span>): content <span class="op">=</span> [content]</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    content <span class="op">=</span> [<span class="va">self</span>.mk_content(o, text_only<span class="op">=</span>text_only) <span class="cf">for</span> o <span class="kw">in</span> content] <span class="cf">if</span> content <span class="cf">else</span> <span class="st">''</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="bu">dict</span>(role<span class="op">=</span>role, content<span class="op">=</span>content[<span class="dv">0</span>] <span class="cf">if</span> text_only <span class="cf">else</span> content, <span class="op">**</span>kw)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>OpenAI implementations:</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L68" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="openaimsg.text_msg" class="level3">
<h3 class="anchored" data-anchor-id="openaimsg.text_msg">OpenAiMsg.text_msg</h3>
<blockquote class="blockquote">
<pre><code> OpenAiMsg.text_msg (s:str, text_only=False)</code></pre>
</blockquote>
<p><em>Convert <code>s</code> to a text message</em></p>
<div id="cell-63" class="cell" data-execution_count="47">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> img_msg(<span class="va">self</span>:OpenAiMsg, data:<span class="bu">bytes</span>)<span class="op">-&gt;</span><span class="bu">dict</span>:</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Convert `data` to an image message"</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>    img, mtype <span class="op">=</span> _mk_img(data)</span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">"type"</span>: <span class="st">"input_image"</span>, <span class="st">"image_url"</span>: <span class="ss">f"data:</span><span class="sc">{</span>mtype<span class="sc">}</span><span class="ss">;base64,</span><span class="sc">{</span>img<span class="sc">}</span><span class="ss">"</span>}</span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> text_msg(<span class="va">self</span>:OpenAiMsg, s:<span class="bu">str</span>, text_only<span class="op">=</span><span class="va">False</span>)<span class="op">-&gt;</span><span class="bu">dict</span>: </span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Convert `s` to a text message"</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> s <span class="cf">if</span> text_only <span class="cf">else</span> {<span class="st">"type"</span>: <span class="st">"input_text"</span>, <span class="st">"text"</span>:s}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L62" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="openaimsg.img_msg" class="level3">
<h3 class="anchored" data-anchor-id="openaimsg.img_msg">OpenAiMsg.img_msg</h3>
<blockquote class="blockquote">
<pre><code> OpenAiMsg.img_msg (data:bytes)</code></pre>
</blockquote>
<p><em>Convert <code>data</code> to an image message</em></p>
<p>Anthropic implementations:</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L81" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="anthropicmsg.text_msg" class="level3">
<h3 class="anchored" data-anchor-id="anthropicmsg.text_msg">AnthropicMsg.text_msg</h3>
<blockquote class="blockquote">
<pre><code> AnthropicMsg.text_msg (s:str, text_only=False)</code></pre>
</blockquote>
<p><em>Convert <code>s</code> to a text message</em></p>
<div id="cell-67" class="cell" data-execution_count="48">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> img_msg(<span class="va">self</span>:AnthropicMsg, data:<span class="bu">bytes</span>)<span class="op">-&gt;</span><span class="bu">dict</span>:</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Convert `data` to an image message"</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    img, mtype <span class="op">=</span> _mk_img(data)</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>    r <span class="op">=</span> {<span class="st">"type"</span>: <span class="st">"base64"</span>, <span class="st">"media_type"</span>: mtype, <span class="st">"data"</span>:img}</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">"type"</span>: <span class="st">"image"</span>, <span class="st">"source"</span>: r}</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> text_msg(<span class="va">self</span>:AnthropicMsg, s:<span class="bu">str</span>, text_only<span class="op">=</span><span class="va">False</span>)<span class="op">-&gt;</span><span class="bu">dict</span>: </span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Convert `s` to a text message"</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> s <span class="cf">if</span> text_only <span class="cf">else</span> {<span class="st">"type"</span>: <span class="st">"text"</span>, <span class="st">"text"</span>:s}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<hr>
<p><a href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L74" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="anthropicmsg.img_msg" class="level3">
<h3 class="anchored" data-anchor-id="anthropicmsg.img_msg">AnthropicMsg.img_msg</h3>
<blockquote class="blockquote">
<pre><code> AnthropicMsg.img_msg (data:bytes)</code></pre>
</blockquote>
<p><em>Convert <code>data</code> to an image message</em></p>
<p>Update <a href="https://AnswerDotAI.github.io/msglm/core.html#mk_msg"><code>mk_msg</code></a> to use <a href="https://AnswerDotAI.github.io/msglm/core.html#msg"><code>Msg</code></a>.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L86" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="mk_msg-1" class="level3">
<h3 class="anchored" data-anchor-id="mk_msg-1">mk_msg</h3>
<blockquote class="blockquote">
<pre><code> mk_msg (content:Union[list,str], role:str='user', *args,
         api:str='openai', **kw)</code></pre>
</blockquote>
<p><em>Create an OpenAI/Anthropic compatible message.</em></p>
<div id="cell-71" class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a>mk_msg([<span class="st">"Hello world"</span>, <span class="st">"how are you?"</span>], api<span class="op">=</span><span class="st">'openai'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="sourceCode" id="cb48"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="er">'content'</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span><span class="er">'text'</span><span class="fu">:</span> <span class="er">'Hello</span> <span class="er">world'</span><span class="fu">,</span> <span class="er">'type'</span><span class="fu">:</span> <span class="er">'input_text'</span><span class="fu">}</span><span class="ot">,</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>               <span class="fu">{</span><span class="er">'text'</span><span class="fu">:</span> <span class="er">'how</span> <span class="er">are</span> <span class="er">you?'</span><span class="fu">,</span> <span class="er">'type'</span><span class="fu">:</span> <span class="er">'input_text'</span><span class="fu">}</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>  <span class="er">'role'</span><span class="fu">:</span> <span class="er">'user'</span><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="cell-72" class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>mk_msg([<span class="st">"Hello world"</span>, <span class="st">"how are you?"</span>], api<span class="op">=</span><span class="st">'anthropic'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown">
<div class="sourceCode" id="cb50"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="er">'content'</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span><span class="er">'text'</span><span class="fu">:</span> <span class="er">'Hello</span> <span class="er">world'</span><span class="fu">,</span> <span class="er">'type'</span><span class="fu">:</span> <span class="er">'text'</span><span class="fu">}</span><span class="ot">,</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>               <span class="fu">{</span><span class="er">'text'</span><span class="fu">:</span> <span class="er">'how</span> <span class="er">are</span> <span class="er">you?'</span><span class="fu">,</span> <span class="er">'type'</span><span class="fu">:</span> <span class="er">'text'</span><span class="fu">}</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="er">'role'</span><span class="fu">:</span> <span class="er">'user'</span><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="cell-73" class="cell">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>msg <span class="op">=</span> mk_msg([img_content, <span class="st">"describe this picture"</span>], api<span class="op">=</span><span class="st">"openai"</span>)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>_, text <span class="op">=</span> openai_chat([msg])</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>text</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>'A small puppy, likely a young spaniel, is lying in green grass beside a pot of purple daisy-like flowers. Key details:  \n• Coat: Soft white fur with rich chestnut-brown patches, especially around its floppy ears and eyes.  \n• Pose: Front paws stretched forward, body low to the ground, head slightly tilted, looking straight at the camera with a curious, gentle expression.  \n• Setting: Bright daylight, fresh green lawn, and clusters of delicate purple blooms tucked into a terracotta or wooden planter just behind the puppy.  \n• Mood: Calm and inquisitive—its wide eyes and relaxed posture give the impression it’s quietly exploring its surroundings.'</code></pre>
</div>
</div>
<div id="cell-74" class="cell">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>msg <span class="op">=</span> mk_msg([img_content, <span class="st">"describe this picture"</span>], api<span class="op">=</span><span class="st">"anthropic"</span>)</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>_, text <span class="op">=</span> anthropic_chat([msg])</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>text</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<pre><code>"This is an adorable photograph of a young puppy, likely a Cavalier King Charles Spaniel or similar breed, with beautiful reddish-brown and white fur markings. The puppy has distinctive coloring with a white face featuring a brown patch around one eye, and longer, silky ears that are a rich auburn color. \n\nThe puppy is positioned on green grass and appears to be resting or lying down near some purple flowers, which look like small daisies or asters. The setting appears to be outdoors in a garden area, with what looks like a brick or stone structure in the background. The lighting gives the photo a warm, natural feel, and the puppy's expression is sweet and gentle, looking directly at the camera with dark, soulful eyes. The overall composition creates a charming, pastoral scene that highlights the puppy's natural beauty."</code></pre>
</div>
</div>
</section>
<section id="pdfs" class="level3">
<h3 class="anchored" data-anchor-id="pdfs">PDFs</h3>
<p>What about chatting with PDFs? Unfortunately, OpenAI’s message completions API doesn’t offer PDF support at the moment, but Claude <a href="https://docs.anthropic.com/en/docs/build-with-claude/pdf-support">does</a>.</p>
<p>Under the hood, Claude extracts the text from the PDF and converts each page to an image. This means you can ask Claude about any text, pictures, charts, and tables in the PDF. Here’s an example from the Claude <a href="https://docs.anthropic.com/en/docs/build-with-claude/pdf-support#how-to-use-pdfs-in-the-messages-api">docs</a>. Overall the message structure is pretty similar to an image message.</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>pdf_url <span class="op">=</span> <span class="st">"https://assets.anthropic.com/m/1cd9d098ac3e6467/original/Claude-3-Model-Card-October-Addendum.pdf"</span></span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>pdf_data <span class="op">=</span> base64.standard_b64encode(httpx.get(pdf_url).content).decode(<span class="st">"utf-8"</span>)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> anthropic.Anthropic()</span>
<span id="cb55-4"><a href="#cb55-4" aria-hidden="true" tabindex="-1"></a>message <span class="op">=</span> client.messages.create(</span>
<span id="cb55-5"><a href="#cb55-5" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"claude-3-5-sonnet-20241022"</span>, max_tokens<span class="op">=</span><span class="dv">1024</span>,</span>
<span id="cb55-6"><a href="#cb55-6" aria-hidden="true" tabindex="-1"></a>    messages<span class="op">=</span>[{</span>
<span id="cb55-7"><a href="#cb55-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"role"</span>: <span class="st">"user"</span>,</span>
<span id="cb55-8"><a href="#cb55-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"content"</span>: [</span>
<span id="cb55-9"><a href="#cb55-9" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb55-10"><a href="#cb55-10" aria-hidden="true" tabindex="-1"></a>                <span class="st">"type"</span>: <span class="st">"document"</span>,</span>
<span id="cb55-11"><a href="#cb55-11" aria-hidden="true" tabindex="-1"></a>                <span class="st">"source"</span>: { <span class="st">"type"</span>: <span class="st">"base64"</span>, <span class="st">"media_type"</span>: <span class="st">"application/pdf"</span>, <span class="st">"data"</span>: pdf_data }</span>
<span id="cb55-12"><a href="#cb55-12" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb55-13"><a href="#cb55-13" aria-hidden="true" tabindex="-1"></a>            {</span>
<span id="cb55-14"><a href="#cb55-14" aria-hidden="true" tabindex="-1"></a>                <span class="st">"type"</span>: <span class="st">"text"</span>,</span>
<span id="cb55-15"><a href="#cb55-15" aria-hidden="true" tabindex="-1"></a>                <span class="st">"text"</span>: <span class="st">"Which model has the highest human preference win rates across each use-case?"</span></span>
<span id="cb55-16"><a href="#cb55-16" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb55-17"><a href="#cb55-17" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb55-18"><a href="#cb55-18" aria-hidden="true" tabindex="-1"></a>    }]</span>
<span id="cb55-19"><a href="#cb55-19" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The Anthropic API has since offered an option for PDFs that can be accessed online via url.</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> anthropic.Anthropic()</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>message <span class="op">=</span> client.messages.create(</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>    model<span class="op">=</span><span class="st">"claude-opus-4-20250514"</span>,</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>    max_tokens<span class="op">=</span><span class="dv">1024</span>,</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>    messages<span class="op">=</span>[</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>            <span class="st">"role"</span>: <span class="st">"user"</span>,</span>
<span id="cb56-8"><a href="#cb56-8" aria-hidden="true" tabindex="-1"></a>            <span class="st">"content"</span>: [</span>
<span id="cb56-9"><a href="#cb56-9" aria-hidden="true" tabindex="-1"></a>                {</span>
<span id="cb56-10"><a href="#cb56-10" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"type"</span>: <span class="st">"document"</span>,</span>
<span id="cb56-11"><a href="#cb56-11" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"source"</span>: {</span>
<span id="cb56-12"><a href="#cb56-12" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"type"</span>: <span class="st">"url"</span>,</span>
<span id="cb56-13"><a href="#cb56-13" aria-hidden="true" tabindex="-1"></a>                        <span class="st">"url"</span>: <span class="st">"https://assets.anthropic.com/m/1cd9d098ac3e6467/original/Claude-3-Model-Card-October-Addendum.pdf"</span></span>
<span id="cb56-14"><a href="#cb56-14" aria-hidden="true" tabindex="-1"></a>                    }</span>
<span id="cb56-15"><a href="#cb56-15" aria-hidden="true" tabindex="-1"></a>                },</span>
<span id="cb56-16"><a href="#cb56-16" aria-hidden="true" tabindex="-1"></a>                {</span>
<span id="cb56-17"><a href="#cb56-17" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"type"</span>: <span class="st">"text"</span>,</span>
<span id="cb56-18"><a href="#cb56-18" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"text"</span>: <span class="st">"What are the key findings in this document?"</span></span>
<span id="cb56-19"><a href="#cb56-19" aria-hidden="true" tabindex="-1"></a>                }</span>
<span id="cb56-20"><a href="#cb56-20" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb56-21"><a href="#cb56-21" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb56-22"><a href="#cb56-22" aria-hidden="true" tabindex="-1"></a>    ],</span>
<span id="cb56-23"><a href="#cb56-23" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Let’s create a method that converts a byte string to the base64 encoded string that Anthropic expects.</p>
<div id="cell-79" class="cell" data-execution_count="38">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> _mk_pdf(data:<span class="bu">bytes</span>)<span class="op">-&gt;</span><span class="bu">str</span>:</span>
<span id="cb57-2"><a href="#cb57-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Convert pdf bytes to a base64 encoded pdf"</span></span>
<span id="cb57-3"><a href="#cb57-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> base64.standard_b64encode(data).decode(<span class="st">"utf-8"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>We add a <code>pdf_msg</code> method to <a href="https://AnswerDotAI.github.io/msglm/core.html#anthropicmsg"><code>AnthropicMsg</code></a> that uses <a href="https://AnswerDotAI.github.io/msglm/core.html#_mk_pdf"><code>_mk_pdf</code></a>.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L100" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="anthropicmsg.pdf_msg" class="level3">
<h3 class="anchored" data-anchor-id="anthropicmsg.pdf_msg">AnthropicMsg.pdf_msg</h3>
<blockquote class="blockquote">
<pre><code> AnthropicMsg.pdf_msg (data:bytes|str)</code></pre>
</blockquote>
<p><em>Convert <code>data</code> to a pdf message</em></p>
<div id="cell-82" class="cell" data-execution_count="70">
<details open="" class="code-fold">
<summary>Exported source</summary>
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="at">@patch</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> pdf_msg(<span class="va">self</span>:AnthropicMsg, data: <span class="bu">bytes</span> <span class="op">|</span> <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">dict</span>:</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Convert `data` to a pdf message"</span></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(data, <span class="bu">bytes</span>):</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a>        r <span class="op">=</span> {<span class="st">"type"</span>: <span class="st">"base64"</span>, <span class="st">"media_type"</span>: <span class="st">"application/pdf"</span>, <span class="st">"data"</span>:_mk_pdf(data)}</span>
<span id="cb59-6"><a href="#cb59-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="bu">isinstance</span>(data, <span class="bu">str</span>):</span>
<span id="cb59-7"><a href="#cb59-7" aria-hidden="true" tabindex="-1"></a>        r <span class="op">=</span> {<span class="st">"type"</span>: <span class="st">"url"</span>, <span class="st">"url"</span>: data}</span>
<span id="cb59-8"><a href="#cb59-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> {<span class="st">"type"</span>: <span class="st">"document"</span>, <span class="st">"source"</span>: r}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Let’s test our changes on a financial report.</p>
<div id="cell-84" class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a>pdf <span class="op">=</span> Path(<span class="st">'financial_report.pdf'</span>).read_bytes()</span>
<span id="cb60-2"><a href="#cb60-2" aria-hidden="true" tabindex="-1"></a>msg <span class="op">=</span> mk_msg([pdf, <span class="st">"what was the average monthly revenue for product D?"</span>], api<span class="op">=</span><span class="st">"anthropic"</span>)</span>
<span id="cb60-3"><a href="#cb60-3" aria-hidden="true" tabindex="-1"></a>_, text <span class="op">=</span> anthropic_chat([msg])</span>
<span id="cb60-4"><a href="#cb60-4" aria-hidden="true" tabindex="-1"></a>text</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="65">
<pre><code>'Looking at the Product D chart on page 5, I can read the monthly revenue values from the bar chart:\n\n- January: ~900\n- February: ~500\n- March: ~400\n- April: ~700\n- May: ~800\n- June: ~900\n- July: ~1000\n- August: ~1050\n- September: ~1200\n- October: ~1300\n- November: ~1300\n- December: ~1300\n\nAdding these values: 900 + 500 + 400 + 700 + 800 + 900 + 1000 + 1050 + 1200 + 1300 + 1300 + 1300 = 11,350\n\nThe average monthly revenue for Product D was 11,350 ÷ 12 = **$946** (rounded to the nearest dollar).'</code></pre>
</div>
</div>
<div id="cell-85" class="cell" data-execution_count="84">
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a>pdf_url <span class="op">=</span> <span class="st">"https://arxiv.org/pdf/2506.18880"</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>msg <span class="op">=</span> mk_msg([pdf_url, <span class="st">"What were the three types of generalization the authors of this paper looked at?"</span>], api<span class="op">=</span><span class="st">"anthropic"</span>)</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a>_, text <span class="op">=</span> anthropic_chat([msg])</span>
<span id="cb62-4"><a href="#cb62-4" aria-hidden="true" tabindex="-1"></a>text</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="84">
<pre><code>"According to the paper, the three types of generalization the authors examined were:\n\n1. **Exploratory Generalization** - Applying known problem-solving skills to more complex instances within the same problem domain. For example, counting rectangles in an octagon (training) versus a dodecagon (test).\n\n2. **Compositional Generalization** - Combining distinct reasoning skills that were previously learned in isolation to solve novel problems that require integrating these skills in new and coherent ways. For example, combining GCD computation with polynomial root-finding.\n\n3. **Transformative Generalization** - Adopting novel, often unconventional strategies by moving beyond familiar approaches to solve problems more effectively. For example, replacing brute-force enumeration with a subtractive counting method that overcounts and then removes invalid cases.\n\nThese three axes of generalization were inspired by Margaret Boden's typology of creativity in cognitive science. The authors designed OMEGA to systematically evaluate large language models across these dimensions using controlled training-test pairs that isolate specific reasoning capabilities within mathematical problem-solving contexts."</code></pre>
</div>
</div>
</section>
<section id="conversation" class="level3">
<h3 class="anchored" data-anchor-id="conversation">Conversation</h3>
<p>LLMs are stateless. To continue a conversation we need to include the entire message history in every API call. By default the role in each message alternates between <code>user</code> and <code>assistant</code>.</p>
<p>Let’s add a method that alternates the roles for us and then calls <a href="https://AnswerDotAI.github.io/msglm/core.html#mk_msgs"><code>mk_msgs</code></a>.</p>
<div id="cell-88" class="cell" data-execution_count="85">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> mk_msgs(msgs: <span class="bu">list</span>, <span class="op">*</span>args, api:<span class="bu">str</span><span class="op">=</span><span class="st">"openai"</span>, <span class="op">**</span>kw) <span class="op">-&gt;</span> <span class="bu">list</span>:</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">"Create a list of messages compatible with OpenAI/Anthropic."</span></span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(msgs, <span class="bu">str</span>): msgs <span class="op">=</span> [msgs]</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> [mk_msg(o, (<span class="st">'user'</span>, <span class="st">'assistant'</span>)[i <span class="op">%</span> <span class="dv">2</span>], <span class="op">*</span>args, api<span class="op">=</span>api, <span class="op">**</span>kw) <span class="cf">for</span> i, o <span class="kw">in</span> <span class="bu">enumerate</span>(msgs)]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="cell-89" class="cell" data-execution_count="86">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1" aria-hidden="true" tabindex="-1"></a>mk_msgs([<span class="st">"Hello"</span>, <span class="st">"Some assistant response"</span>, <span class="st">"tell me a joke"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="86">
<pre><code>[{'role': 'user', 'content': 'Hello'},
 {'role': 'assistant', 'content': 'Some assistant response'},
 {'role': 'user', 'content': 'tell me a joke'}]</code></pre>
</div>
</div>
</section>
<section id="sdk-objects" class="level3">
<h3 class="anchored" data-anchor-id="sdk-objects">SDK Objects</h3>
<p>To make our lives even easier, it would be nice if <a href="https://AnswerDotAI.github.io/msglm/core.html#mk_msg"><code>mk_msg</code></a> could format the SDK objects returned from a previous chat so that we can pass them straight to <a href="https://AnswerDotAI.github.io/msglm/core.html#mk_msgs"><code>mk_msgs</code></a>.</p>
<p>The OpenAI SDK accepts objects like <code>ChatCompletion</code> as messages. Anthropic is different and expects every message to have the <code>role</code>, <code>content</code> format that we’ve seen so far.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L111" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="msg.__call__" class="level3">
<h3 class="anchored" data-anchor-id="msg.__call__">Msg.__call__</h3>
<blockquote class="blockquote">
<pre><code> Msg.__call__ (role:str, content:[&lt;class'list'&gt;,&lt;class'str'&gt;],
               text_only:bool=False, **kw)</code></pre>
</blockquote>
<p><em>Create an OpenAI/Anthropic compatible message with <code>role</code> and <code>content</code>.</em></p>
<hr>
<p><a href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L131" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="anthropicmsg.find_block" class="level3">
<h3 class="anchored" data-anchor-id="anthropicmsg.find_block">AnthropicMsg.find_block</h3>
<blockquote class="blockquote">
<pre><code> AnthropicMsg.find_block (r)</code></pre>
</blockquote>
<p><em>Find the message in <code>r</code>.</em></p>
<hr>
<p><a href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L126" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="anthropicmsg.is_sdk_obj" class="level3">
<h3 class="anchored" data-anchor-id="anthropicmsg.is_sdk_obj">AnthropicMsg.is_sdk_obj</h3>
<blockquote class="blockquote">
<pre><code> AnthropicMsg.is_sdk_obj (r)</code></pre>
</blockquote>
<p><em>Check if <code>r</code> is an SDK object.</em></p>
<hr>
<p><a href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L143" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="openaimsg.find_block" class="level3">
<h3 class="anchored" data-anchor-id="openaimsg.find_block">OpenAiMsg.find_block</h3>
<blockquote class="blockquote">
<pre><code> OpenAiMsg.find_block (r)</code></pre>
</blockquote>
<p><em>Find the message in <code>r</code>.</em></p>
<hr>
<p><a href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L137" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="openaimsg.is_sdk_obj" class="level3">
<h3 class="anchored" data-anchor-id="openaimsg.is_sdk_obj">OpenAiMsg.is_sdk_obj</h3>
<blockquote class="blockquote">
<pre><code> OpenAiMsg.is_sdk_obj (r)</code></pre>
</blockquote>
<p><em>Check if <code>r</code> is an SDK object.</em></p>
<hr>
<p><a href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L150" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="mk_msgs" class="level3">
<h3 class="anchored" data-anchor-id="mk_msgs">mk_msgs</h3>
<blockquote class="blockquote">
<pre><code> mk_msgs (msgs:list, *args, api:str='openai', **kw)</code></pre>
</blockquote>
<p><em>Create a list of messages compatible with OpenAI/Anthropic.</em></p>
<p>Let’s test our changes.</p>
<div id="cell-99" class="cell" data-execution_count="92">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>msgs <span class="op">=</span> [<span class="st">"tell me a joke"</span>]</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>r, text <span class="op">=</span> openai_chat(mk_msgs(msgs))</span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>text</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="92">
<pre><code>'Why don’t scientists trust atoms?  \nBecause they make up everything!'</code></pre>
</div>
</div>
<div id="cell-100" class="cell" data-execution_count="93">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>msgs <span class="op">+=</span> [r, <span class="st">"tell me another joke that's similar to your first joke"</span>]</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>mm <span class="op">=</span> mk_msgs(msgs)</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>mm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="93">
<pre><code>[{'role': 'user', 'content': 'tell me a joke'},
 ResponseReasoningItem(id='rs_6861ee59eb80819d9b284f7e3592abd50325e602e0c97467', summary=[], type='reasoning', encrypted_content=None, status=None),
 ResponseOutputMessage(id='msg_6861ee5ad01c819d86aa11520c3c9e0b0325e602e0c97467', content=[ResponseOutputText(annotations=[], text='Why don’t scientists trust atoms?  \nBecause they make up everything!', type='output_text', logprobs=[])], role='assistant', status='completed', type='message'),
 {'role': 'user',
  'content': "tell me another joke that's similar to your first joke"}]</code></pre>
</div>
</div>
<div id="cell-101" class="cell" data-execution_count="94">
<div class="sourceCode cell-code" id="cb77"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb77-1"><a href="#cb77-1" aria-hidden="true" tabindex="-1"></a>r, text <span class="op">=</span> openai_chat(mm)</span>
<span id="cb77-2"><a href="#cb77-2" aria-hidden="true" tabindex="-1"></a>text</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="94">
<pre><code>'Why don’t scientists trust electrons?  \nBecause they’re always negative!'</code></pre>
</div>
</div>
</section>
<section id="usage" class="level3">
<h3 class="anchored" data-anchor-id="usage">Usage</h3>
<p>To make <code>msglm</code> a little easier to use let’s create OpenAI and Anthropic wrappers for <a href="https://AnswerDotAI.github.io/msglm/core.html#mk_msg"><code>mk_msg</code></a> and <a href="https://AnswerDotAI.github.io/msglm/core.html#mk_msgs"><code>mk_msgs</code></a>.</p>
<div id="cell-104" class="cell" data-execution_count="96">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a>mk_msg_anthropic <span class="op">=</span> partial(mk_msg, api<span class="op">=</span><span class="st">"anthropic"</span>)</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>mk_msgs_anthropic <span class="op">=</span> partial(mk_msgs, api<span class="op">=</span><span class="st">"anthropic"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>If you’re using OpenAI you should be able to use the import below</p>
<div class="sourceCode" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> msglm <span class="im">import</span> mk_msg_openai <span class="im">as</span> mk_msg, mk_msgs_openai <span class="im">as</span> mk_msgs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Similarily for Anthropic</p>
<div class="sourceCode" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> msglm <span class="im">import</span> mk_msg_anthropic <span class="im">as</span> mk_msg, mk_msgs_anthropic <span class="im">as</span> mk_msgs</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="extra-features" class="level2">
<h2 class="anchored" data-anchor-id="extra-features">Extra features</h2>
<section id="caching" class="level3">
<h3 class="anchored" data-anchor-id="caching">Caching</h3>
<p>Anthropic currently offers <a href="https://docs.anthropic.com/en/docs/build-with-claude/prompt-caching">prompt caching</a>, which can reduce cost and latency.</p>
<p>To cache a message, we simply add a <code>cache_control</code> field to our content as shown below.</p>
<div class="sourceCode" id="cb82"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb82-1"><a href="#cb82-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb82-2"><a href="#cb82-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"role"</span><span class="op">:</span> <span class="st">"user"</span><span class="op">,</span></span>
<span id="cb82-3"><a href="#cb82-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"content"</span><span class="op">:</span> [</span>
<span id="cb82-4"><a href="#cb82-4" aria-hidden="true" tabindex="-1"></a>        {</span>
<span id="cb82-5"><a href="#cb82-5" aria-hidden="true" tabindex="-1"></a>            <span class="st">"type"</span><span class="op">:</span> <span class="st">"text"</span><span class="op">,</span></span>
<span id="cb82-6"><a href="#cb82-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">"text"</span><span class="op">:</span> <span class="st">"Hello, can you tell me more about the solar system?"</span><span class="op">,</span></span>
<span id="cb82-7"><a href="#cb82-7" aria-hidden="true" tabindex="-1"></a>            <span class="st">"cache_control"</span><span class="op">:</span> {<span class="st">"type"</span><span class="op">:</span> <span class="st">"ephemeral"</span>}</span>
<span id="cb82-8"><a href="#cb82-8" aria-hidden="true" tabindex="-1"></a>        }</span>
<span id="cb82-9"><a href="#cb82-9" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb82-10"><a href="#cb82-10" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Let’s update our <a href="https://AnswerDotAI.github.io/msglm/core.html#mk_msg"><code>mk_msg</code></a> and <a href="https://AnswerDotAI.github.io/msglm/core.html#mk_msgs"><code>mk_msgs</code></a> Anthropic wrappers to support caching.</p>
<hr>
<p><a href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L187" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="mk_msgs_anthropic" class="level3">
<h3 class="anchored" data-anchor-id="mk_msgs_anthropic">mk_msgs_anthropic</h3>
<blockquote class="blockquote">
<pre><code> mk_msgs_anthropic (*args, cache=False, cache_last_ckpt_only=False,
                    api:str='openai')</code></pre>
</blockquote>
<p><em>Create a list of Anthropic compatible messages.</em></p>
<hr>
<p><a href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L181" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="mk_msg_anthropic" class="level3">
<h3 class="anchored" data-anchor-id="mk_msg_anthropic">mk_msg_anthropic</h3>
<blockquote class="blockquote">
<pre><code> mk_msg_anthropic (*args, cache=False, role:str='user', api:str='openai')</code></pre>
</blockquote>
<p><em>Create an Anthropic compatible message.</em></p>
<p>Let’s see caching in action</p>
<div id="cell-113" class="cell" data-execution_count="98">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1" aria-hidden="true" tabindex="-1"></a>mk_msg_anthropic(<span class="st">"Don't cache my message"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="98">
<div class="sourceCode" id="cb86"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span><span class="er">'content'</span><span class="fu">:</span> <span class="st">"Don't cache my message"</span><span class="fu">,</span> <span class="er">'role'</span><span class="fu">:</span> <span class="er">'user'</span><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
<div id="cell-114" class="cell" data-execution_count="99">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>mk_msg_anthropic(<span class="st">"Please cache my message"</span>, cache<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="99">
<div class="sourceCode" id="cb88"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="er">'content'</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="er">'cache_control'</span><span class="fu">:</span> <span class="fu">{</span><span class="er">'type'</span><span class="fu">:</span> <span class="er">'ephemeral'</span><span class="fu">},</span></span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>                 <span class="er">'text'</span><span class="fu">:</span> <span class="er">'Please</span> <span class="er">cache</span> <span class="er">my</span> <span class="er">message'</span><span class="fu">,</span></span>
<span id="cb88-3"><a href="#cb88-3" aria-hidden="true" tabindex="-1"></a>                 <span class="er">'type'</span><span class="fu">:</span> <span class="er">'text'</span><span class="fu">}</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb88-4"><a href="#cb88-4" aria-hidden="true" tabindex="-1"></a>  <span class="er">'role'</span><span class="fu">:</span> <span class="er">'user'</span><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>
</section>
<section id="citations" class="level3">
<h3 class="anchored" data-anchor-id="citations">Citations</h3>
<p>The Anthropic API provides detailed <a href="https://docs.anthropic.com/en/docs/build-with-claude/citations">citations</a> when answering questions about documents.</p>
<p>When citations are enabled a citations block like the one below will be included in the response.</p>
<div class="sourceCode" id="cb89"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"content"</span><span class="op">:</span> [</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a>    { <span class="st">"type"</span><span class="op">:</span> <span class="st">"text"</span><span class="op">,</span> <span class="st">"text"</span><span class="op">:</span> <span class="st">"According to the document, "</span> }<span class="op">,</span></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>      <span class="st">"type"</span><span class="op">:</span> <span class="st">"text"</span><span class="op">,</span> <span class="st">"text"</span><span class="op">:</span> <span class="st">"the grass is green"</span><span class="op">,</span></span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a>      <span class="st">"citations"</span><span class="op">:</span> [{</span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">"type"</span><span class="op">:</span> <span class="st">"char_location"</span><span class="op">,</span></span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a>        <span class="st">"cited_text"</span><span class="op">:</span> <span class="st">"The grass is green."</span><span class="op">,</span></span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a>        <span class="st">"document_index"</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="st">"document_title"</span><span class="op">:</span> <span class="st">"Example Document"</span><span class="op">,</span></span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a>        <span class="st">"start_char_index"</span><span class="op">:</span> <span class="dv">0</span><span class="op">,</span> <span class="st">"end_char_index"</span><span class="op">:</span> <span class="dv">20</span></span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a>      }]</span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>To enable citations you need to create an Anthropic document with the following structure.</p>
<div class="sourceCode" id="cb90"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb90-1"><a href="#cb90-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb90-2"><a href="#cb90-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"type"</span><span class="op">:</span> <span class="st">"document"</span><span class="op">,</span></span>
<span id="cb90-3"><a href="#cb90-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"source"</span><span class="op">:</span> {<span class="op">...</span>}<span class="op">,</span></span>
<span id="cb90-4"><a href="#cb90-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"title"</span><span class="op">:</span> <span class="st">"Document Title"</span><span class="op">,</span> # optional</span>
<span id="cb90-5"><a href="#cb90-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"context"</span><span class="op">:</span> <span class="st">"Context about the document that will not be cited from"</span><span class="op">,</span> # optional</span>
<span id="cb90-6"><a href="#cb90-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">"citations"</span><span class="op">:</span> {<span class="st">"enabled"</span><span class="op">:</span> True}</span>
<span id="cb90-7"><a href="#cb90-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Currently Anthropic supports citations on 3 document types: - text - pdfs - custom</p>
<p>A <strong>text</strong> document has the following source structure.</p>
<div class="sourceCode" id="cb91"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a>{<span class="st">"type"</span><span class="op">:</span> <span class="st">"text"</span><span class="op">,</span> <span class="st">"media_type"</span><span class="op">:</span> <span class="st">"text/plain"</span><span class="op">,</span> <span class="st">"data"</span><span class="op">:</span> <span class="st">"Plain text content..."</span>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Here’s the source structure for a <strong>pdf</strong>.</p>
<div class="sourceCode" id="cb92"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>{<span class="st">"type"</span><span class="op">:</span> <span class="st">"base64"</span><span class="op">,</span> <span class="st">"media_type"</span><span class="op">:</span> <span class="st">"application/pdf"</span><span class="op">,</span> <span class="st">"data"</span><span class="op">:</span> b64_enc_data}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>Finally, here’s the source structure for a <strong>custom</strong> document.</p>
<div class="sourceCode" id="cb93"><pre class="sourceCode js code-with-copy"><code class="sourceCode javascript"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>{</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>  <span class="st">"type"</span><span class="op">:</span> <span class="st">"content"</span><span class="op">,</span></span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"content"</span><span class="op">:</span> [</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"type"</span><span class="op">:</span> <span class="st">"text"</span><span class="op">,</span> <span class="st">"text"</span><span class="op">:</span> <span class="st">"First chunk"</span>}<span class="op">,</span></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>    {<span class="st">"type"</span><span class="op">:</span> <span class="st">"text"</span><span class="op">,</span> <span class="st">"text"</span><span class="op">:</span> <span class="st">"Second chunk"</span>}</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>  ]</span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<hr>
<p><a href="https://github.com/AnswerDotAI/msglm/blob/main/msglm/core.py#L196" target="_blank" style="float:right; font-size:smaller">source</a></p>
</section>
<section id="mk_ant_doc" class="level3">
<h3 class="anchored" data-anchor-id="mk_ant_doc">mk_ant_doc</h3>
<blockquote class="blockquote">
<pre><code> mk_ant_doc (content, title=None, context=None, citation=True, **kws)</code></pre>
</blockquote>
<p><em>Create an Anthropic document.</em></p>
<p>Here’s how you would implement the example from the citation’s <a href="https://docs.anthropic.com/en/docs/build-with-claude/citations">docs</a>.</p>
<div id="cell-121" class="cell" data-execution_count="101">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a>doc <span class="op">=</span> mk_ant_doc(<span class="st">"The grass is green. The sky is blue."</span>, title<span class="op">=</span><span class="st">"My Document"</span>, context<span class="op">=</span><span class="st">"This is a trustworthy document."</span>)</span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>mk_msg([doc, <span class="st">"What color is the grass and sky?"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display cell-output-markdown" data-execution_count="101">
<div class="sourceCode" id="cb96"><pre class="sourceCode json code-with-copy"><code class="sourceCode json"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a><span class="fu">{</span> <span class="er">'content'</span><span class="fu">:</span> <span class="ot">[</span> <span class="fu">{</span> <span class="er">'citations'</span><span class="fu">:</span> <span class="fu">{</span><span class="er">'enabled'</span><span class="fu">:</span> <span class="er">True</span><span class="fu">},</span></span>
<span id="cb96-2"><a href="#cb96-2" aria-hidden="true" tabindex="-1"></a>                 <span class="er">'context'</span><span class="fu">:</span> <span class="er">'This</span> <span class="er">is</span> <span class="er">a</span> <span class="er">trustworthy</span> <span class="er">document.'</span><span class="fu">,</span></span>
<span id="cb96-3"><a href="#cb96-3" aria-hidden="true" tabindex="-1"></a>                 <span class="er">'source'</span><span class="fu">:</span> <span class="fu">{</span> <span class="er">'data'</span><span class="fu">:</span> <span class="er">'The</span> <span class="er">grass</span> <span class="er">is</span> <span class="er">green.</span> <span class="er">The</span> <span class="er">sky</span> <span class="er">is</span> <span class="er">blue.'</span><span class="fu">,</span></span>
<span id="cb96-4"><a href="#cb96-4" aria-hidden="true" tabindex="-1"></a>                             <span class="er">'media_type'</span><span class="fu">:</span> <span class="er">'text/plain'</span><span class="fu">,</span></span>
<span id="cb96-5"><a href="#cb96-5" aria-hidden="true" tabindex="-1"></a>                             <span class="er">'type'</span><span class="fu">:</span> <span class="er">'text'</span><span class="fu">},</span></span>
<span id="cb96-6"><a href="#cb96-6" aria-hidden="true" tabindex="-1"></a>                 <span class="er">'title'</span><span class="fu">:</span> <span class="er">'My</span> <span class="er">Document'</span><span class="fu">,</span></span>
<span id="cb96-7"><a href="#cb96-7" aria-hidden="true" tabindex="-1"></a>                 <span class="er">'type'</span><span class="fu">:</span> <span class="er">'document'</span><span class="fu">}</span><span class="ot">,</span></span>
<span id="cb96-8"><a href="#cb96-8" aria-hidden="true" tabindex="-1"></a>               <span class="fu">{</span> <span class="er">'text'</span><span class="fu">:</span> <span class="er">'What</span> <span class="er">color</span> <span class="er">is</span> <span class="er">the</span> <span class="er">grass</span> <span class="er">and</span> <span class="er">sky?'</span><span class="fu">,</span></span>
<span id="cb96-9"><a href="#cb96-9" aria-hidden="true" tabindex="-1"></a>                 <span class="er">'type'</span><span class="fu">:</span> <span class="er">'input_text'</span><span class="fu">}</span><span class="ot">]</span><span class="fu">,</span></span>
<span id="cb96-10"><a href="#cb96-10" aria-hidden="true" tabindex="-1"></a>  <span class="er">'role'</span><span class="fu">:</span> <span class="er">'user'</span><span class="fu">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</div>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp("https:\/\/AnswerDotAI\.github\.io\/msglm");
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




<footer class="footer"><div class="nav-footer"><div class="nav-footer-center"><div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/AnswerDotAI/msglm/issues/new" class="toc-action"><i class="bi bi-github"></i>Report an issue</a></li></ul></div></div></div></footer></body></html>